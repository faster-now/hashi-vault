---

- name: Setting the Vault URL
  set_fact:
  # when recertifying TLS certs for already expired certs it is necessary to disable TLS and then use the line below to use HTTP only
    #vault_url: "http://{{ inventory_hostname }}:{{ vault_port }}"
    vault_url: "{{ is_https | ternary('https', 'http') }}://{{ inventory_hostname }}:{{ vault_port }}"

- name: Create TLS certificate
  community.hashi_vault.vault_write:
    url: "{{ vault_url }}"
    path: pki_int/issue/leaf_certs
    data:
      common_name: "{{ cname }}"
      alt_names: "{{ alt_names }}"
      ttl: "{{ cert_lifetime }}"
    token: "{{ vault_token }}"
    validate_certs: false
    token_validate: false
  register: consul_certs_and_keys

- name: Write consul certificate to file
  copy:
    content: "{{ consul_certs_and_keys.data.data.certificate }}"
    dest: "{{ cert_file }}"

- name: Write consul private key to file
  copy:
    content: "{{ consul_certs_and_keys.data.data.private_key }}"
    dest: "{{ key_file }}"

- name: Write ca cert to file
  copy:
    content: "{{ consul_certs_and_keys.data.data.issuing_ca }}"
    dest: "{{ ca_file }}"

# - name: Add new encryption key to config
#   lineinfile:
#     path: "~/consul/{{ item }}.hcl" #Add to all config files
#     regexp: "^encrypt\s*=\s*"
#     line: "encrypt = \"{{ consul_enc_key }}\" #generated by Ansible"
#   notify: Restart Consul #even though in a loop, will only result in one restart
#   when:
#     - consul_enc_key is defined
#   loop: "{{consul_servers}}"

# handlers:
#   - name: Restart Consul
#       docker_container:
#         name: "{{ item }}"
#         image: "{{consul_image_name}}:v1"
#         state: started
#         restart_policy: unless-stopped
#         restart: yes
#         networks:
#           - name: "{{ docker_network }}"
#         volumes:
#           - "~/consul/{{item}}.hcl:/etc/consul/consul.hcl"
#           - "~/consul-storage/{{item}}/:/opt/consul-storage"
#       loop: "{{consul_servers}}"

#TODO update config files then restart containers
