---
- hosts: all
  vars:
    docker_network: vault_net
    user: azureuser
    consul_servers:
      - consul-a
      - consul-b
      - consul-c
    vault_servers: #use dict so a port number can be specified for each vault server to facilitate running multiple containers on a single host
      vault-a: 8200
      vault-b: 8800
    consul_image_name: my-consul
    #temp_build_dir: /tmp/build/consul
    base_dir: ~/ansible
    consul_build_files_dir: consul-files
    vault_build_files_dir: vault-files
    base_vault_dir: ~/vault
    base_consul_dir: ~/consul
    vault_config_dir: ~/vault/config
    consul_config_dir: "{{ base_consul_dir }}/config"
    #force_fetch: true #Assume consul will be built first and force fetch of build files

  gather_facts: no
  remote_user: "{{ user }}"
  become: no

  #"{{ base_dir }}/{{ consul_build_files_dir }}/{{ consul_servers[0] }}"
  tasks:
    - name: Init consul config and build files
      include_role:
        name: init-build-files
      vars:
        force_fetch: true
      #vars: #try this to see if vars from top level play are passed in
        #base_dir: "{{ base_dir }}"
        #vault_config_dir: 
        #consul_config_dir:

    # - name: Init consul config and build files
    #   include_role:
    #     name: init-build-files
    #   vars:
    #     temp_build_dir: /tmp/build/consul
    #     dest_config_dir: ~/consul
    #     dest_build_dir: ~/consul-build

    - name: Create local persistent storage directory for Consul servers (in preparation for Docker volume)
      file:
        path: "{{ base_consul_dir }}/{{ item }}/consul-storage"
        state: directory
        owner: "{{user}}"
        group: "{{user}}"
        mode: 0775
      loop: "{{consul_servers}}"

    - name: Build a Consul image
      docker_image:
        build:
          path: "{{ base_dir }}/{{ consul_build_files_dir }}" #Dockerfile for Consul build should be in user dir/ansible-build subfolder
        name: "{{consul_image_name}}"
        tag: v1
        force_source: yes
        #push: yes
        source: build
      #delegate_to: 127.0.0.1
      #become: no

    - name: Create a docker network
      docker_network:
        name: "{{ docker_network }}"

    - name: Create consul docker containers
      include_role:
        name: consul-container-restart
      vars:
        container_name: "{{ consul_server }}"
        consul_image_version: "v1"
        consul_config_dir: "{{ base_consul_dir }}/{{ consul_server }}/config"
        consul_storage_dir: "{{ base_consul_dir }}/{{ consul_server }}/consul-storage"
        container_restart: yes
      loop: "{{ consul_servers }}"
      loop_control:
        loop_var: consul_server

    - name: Enable gossip encryption
      include_role:
        name: consul-container-restart